## 03장

### 1. 테라폼 상태란?

- terraform apply  명령어 실행 시 terraform.tfstate 파일 생성
- state를 통해 테라폼을 실행할 때 마다 AWS에서 EC2 인스턴스의 최신 상태를 가져와 테라폼의 구성과 비교, 어느 변경 사항을 적용해야 하는지 결정 가능
- terraform plan 명령어는, state 파일의 id를 통해 발견된 현재 테라폼 인프라 코드와, 실제 배포된 인프라 간의 차이를 나타냄
- 개인프로젝트에서 테라폼을 사용하는 경우 로컬 컴퓨터의 단일 terraform.tfstate 파일에 상태를 저장하는 것이 좋음

- 팀단위 프로젝트에서는 다음과 같은 문제들에 직면
    - 상태 파일을 저장하는 공유 스토리지
        - 각 팀원이 동일한 테라폼 상태 파일에 액세스해야함, 즉 공유 위치에 저장해야함
    - 상태 파일 잠금
        - 팀원이 동시에 테라폼을 실행하는 경우 여러 테라폼 프로세스가 상태 파일을 동시에 업데이트하여 충돌 일으킬 수 있음
    - 상태 파일 격리
        - 인프라르 변경할 때는 다른 환경을 격리하는 것이 가장 좋음, 테스트 환경을 변경할 때 실수로 프로덕션 환경이 중단되는 경우는 없는지 확인해야함

### 2. 상태 파일 공유

- 테라폼 상태 파일을 버전 관리 시스템에 저장하는 것은 다음과 같은 이유로 부적절
    - 수동 오류
        - 팀의 누군가가 이전 버전의 상태 파일로 테라폼을 실행할 수 있음
    - 잠금
        - 하나의 상태 파일에 여러명이 동시에 terraform apply가 가능함, 잠금 기능이 없음
    - 시크릿
        - 테라폼의 상태 파일은 모두 plain text로 저장됨
        - 사용자 이름과 비밀번호와 같은 중요한 데이터를 plain text로 저장하는 것은 버전 관리나 보안 측면에서 적절하지 않음
    
- 원격 백엔드를 사용하여 공유
    - Amazon S3, Azure Storage, Terraform Cloud 등이 지원
    - 수동 오류 해결
        - plan, apply 명령을 실행할 때마다 해당 백엔드에서 상태 파일을 자동으로 로드, apply 명령 후 상태 파일을 백엔드에 자동 저장하므로 수동 오류가 발생하지 않음
    - 잠금
        - 원격 백엔드는 기본적으로 잠금 기능을 지원, 다른 사람이 apply 명령을 실행 중인 경우 이미 잠금이 활성화 되어 있어 해제될 때 까지 기다려야함
    - 시크릿
        - 상태 파일을 저장할 때 암호화하는 기능을 지원
        - 또한 최소한 상태 파일이 디스크 어디에도 plain text로 저장되지는 않으므로 보안 문제 해결

### 3. 테라폼 백엔드의 단점

- 테라폼 백엔드를 위한 s3, dynamodb 등을 만드는 것은 과할 수 있음
- 테라폼의 backend 블록에서는 변수나 참조 사용 불가, 아래 코드는 동작하지 않음
    
    ```python
    terraform {
    	backend "s3" {
    		bucket         = var.bucket
    		region         = var.region
    		dynamodb_table = var.dynamodb_table
    		key            = "example/terraform.tfstate"
    		encrypt        = true
    	}
    }
    ```
    
    - s3 버킷 이름, 리전, dynmoadb 테이블 이름 등을 모두 테라폼 모듈에 수동으로 복사해서 붙여넣어야함.
    - 백엔드 인수를 별도의 파일로 저장하여 해당 단점을 극복할 수 있음, backend.hc1 파일 참조
- 해당 명령어로 init 시 backend.hc1 파일 참조 가능
    
    ```python
    terraform init -backend-config=backend.hc1
    ```
    